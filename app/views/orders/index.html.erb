<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>受注一覧</h1>
    <%= link_to '新規受注', new_order_path, class: 'btn btn-primary' %>
  </div>

  <form id="selected-orders-form" action="<%= new_invoice_path %>" method="get">
    <input type="hidden" name="order_ids" id="selected-order-ids" value="">

    <table class="table">
      <thead>
        <tr>
          <th></th>
          <th>ID</th>
          <th>受注番号</th>
          <th>取引先</th>
          <th>受注日</th>
          <th>予定納品日</th>
          <th>確定納品日</th>
          <th>合計金額（税抜）</th>
          <th>合計金額（税込）</th>
          <th>支払い方法</th>
          <th>請求状況</th>
          <th>操作</th>
        </tr>
      </thead>

      <tbody>
        <% @orders.each do |order| %>
          <tr>
            <td>
              <input type="checkbox" class="order-checkbox" 
                    data-customer-id="<%= order.customer_id %>"
                    data-customer-name="<%= order.customer.company_name %>"
                    data-order-id="<%= order.id %>"
                    <%= 'disabled' if order.invoiced? %>>
            </td>
            <td><%= order.id %></td>
            <td><%= link_to order.order_number, order_path(order) %></td>
            <td><%= order.customer.company_name %></td>
            <td><%= l order.order_date %></td>
            <td><%= l order.expected_delivery_date if order.expected_delivery_date %></td>
            <td><%= l order.actual_delivery_date if order.actual_delivery_date %></td>
            <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal_without_tax }) %></td>
            <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal }) %></td>
            <td><%= order.payment_method %></td>
            <td>
              <% if order.invoiced? %>
                <span style="display: inline-block; padding: 0.25em 0.6em; font-size: 0.75rem; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; color: #fff; background-color: #28a745;">請求済</span>
              <% else %>
                <span style="display: inline-block; padding: 0.25em 0.6em; font-size: 0.75rem; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; color: #fff; background-color: #6c757d;">未請求</span>
              <% end %>
            </td>
            <td>
              <%= link_to '詳細', order, class: 'btn btn-sm btn-info' %>
              <%= link_to '編集', edit_order_path(order), class: 'btn btn-sm btn-primary' %>
              <%= form_with(url: order_path(order), method: :delete, class: 'd-inline') do |f| %>
                <%= f.submit '削除', class: 'btn btn-sm btn-danger', data: { confirm: '本当に削除しますか？' }, 
                            onclick: "return confirm('本当に削除しますか？');" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div class="text-center mt-4 mb-4">
      <button type="button" class="btn btn-success" id="create-invoice-btn" disabled>選択した受注情報を合算して請求書を発行</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    const createInvoiceBtn = document.getElementById('create-invoice-btn');
    const selectedOrderIdsInput = document.getElementById('selected-order-ids');
    const form = document.getElementById('selected-orders-form');
    
    // 請求書発行ボタンのクリックイベント
    createInvoiceBtn.addEventListener('click', function() {
      const selectedOrderIds = [];
      
      checkboxes.forEach(cb => {
        if (cb.checked) {
          selectedOrderIds.push(cb.dataset.orderId);
        }
      });
      
      if (selectedOrderIds.length > 0) {
        selectedOrderIdsInput.value = selectedOrderIds.join(',');
        form.submit();
      }
    });
    
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const customerId = this.dataset.customerId;
        let anyChecked = false;
        let selectedCustomerId = null;
        const selectedOrderIds = [];
        
        // どのチェックボックスがチェックされているか確認
        checkboxes.forEach(cb => {
          if (cb.checked) {
            anyChecked = true;
            selectedCustomerId = cb.dataset.customerId;
            selectedOrderIds.push(cb.dataset.orderId);
          }
        });
        
        // チェックボックスがチェックされている場合、異なる取引先のチェックボックスを無効化
        if (anyChecked) {
          checkboxes.forEach(cb => {
            if (cb.dataset.customerId !== selectedCustomerId) {
              cb.disabled = true;
            }
          });
        } else {
          // チェックされていない場合、すべてのチェックボックスを有効化
          checkboxes.forEach(cb => {
            if (!cb.hasAttribute('disabled') || !cb.disabled) {
              cb.disabled = false;
            }
          });
        }

        // 選択されている受注があるか確認し、請求書発行ボタンの有効/無効を設定
        createInvoiceBtn.disabled = !anyChecked;
        
        // 選択された受注IDを隠しフィールドに設定
        selectedOrderIdsInput.value = selectedOrderIds.join(',');
      });
    });
  });
</script> 