<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>受注一覧</h1>
  </div>

  <%# 検索フォームを追加 %>
  <div class="card mb-4">
    <div class="card-header bg-light">
      <button class="btn btn-link btn-sm text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#searchCollapse" aria-expanded="true" aria-controls="searchCollapse">
        <i class="bi bi-search"></i> 検索条件
      </button>
    </div>
    <div class="collapse show" id="searchCollapse">
      <div class="card-body">
        <%= form_with(url: orders_path, method: :get, local: true, id: 'search-form', class: 'row g-3') do |f| %>
          <!-- 1行目：顧客コード、取引先名、受注日、受注番号 -->
          <div class="col-md-2 me-3">
            <label class="form-label">顧客コード</label>
            <%= f.text_field :customer_code,
                value: @search_params&.dig(:customer_code),
                class: 'form-control',
                placeholder: '半角英数' %>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">取引先名</label>
            <div class="position-relative">
              <%= f.text_field :customer_name,
                  id: "customer_name_search",
                  value: @search_params&.dig(:customer_name),
                  class: 'form-control',
                  autocomplete: "off" %>
              <div id="customer_name_suggestions" class="position-absolute w-100 bg-white border rounded shadow-lg" style="z-index: 1000; display: none;"></div>
            </div>
          </div>

          <div class="col-md-4 me-3">
            <label class="form-label">受注日</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= f.date_field :order_date_from,
                    value: @search_params&.dig(:order_date_from),
                    class: 'form-control', placeholder: 'From' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= f.date_field :order_date_to,
                    value: @search_params&.dig(:order_date_to),
                    class: 'form-control', placeholder: 'To' %>
              </div>
            </div>
          </div>

          <div class="col-md-2 me-3">
            <label class="form-label">受注番号</label>
            <%= f.text_field :order_number,
                value: @search_params&.dig(:order_number),
                class: 'form-control' %>
          </div>

          <!-- 2行目：希望納品日、確定納品日、合計金額（範囲検索） -->
          <div class="col-md-4 me-3 clear-left">
            <label class="form-label">希望納品日</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= f.date_field :expected_delivery_date_from,
                    value: @search_params&.dig(:expected_delivery_date_from),
                    class: 'form-control', placeholder: 'From' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= f.date_field :expected_delivery_date_to,
                    value: @search_params&.dig(:expected_delivery_date_to),
                    class: 'form-control', placeholder: 'To' %>
              </div>
            </div>
          </div>

          <div class="col-md-4 me-3">
            <label class="form-label">確定納品日</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= f.date_field :actual_delivery_date_from,
                    value: @search_params&.dig(:actual_delivery_date_from),
                    class: 'form-control', placeholder: 'From' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= f.date_field :actual_delivery_date_to,
                    value: @search_params&.dig(:actual_delivery_date_to),
                    class: 'form-control', placeholder: 'To' %>
              </div>
            </div>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">合計金額（税抜）</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= f.number_field :total_without_tax_from,
                    value: @search_params&.dig(:total_without_tax_from),
                    class: 'form-control', placeholder: '最低金額' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= f.number_field :total_without_tax_to,
                    value: @search_params&.dig(:total_without_tax_to),
                    class: 'form-control', placeholder: '最高金額' %>
              </div>
            </div>
          </div>

          <!-- 3行目：支払方法（チェックボックス複数選択）と請求書ステータス -->
          <div class="col-md-4 me-2 clear-left">
            <label class="form-label">支払い方法</label>
            <div class="d-flex flex-wrap">
              <% @payment_methods.each do |method| %>
                <div class="form-check me-3">
                  <%= check_box_tag "payment_method_ids[]", method.id,
                      (@search_params&.dig(:payment_method_ids) || []).include?(method.id.to_s),
                      { class: 'form-check-input', id: "payment_method_#{method.id}" } %>
                  <label class="form-check-label" for="payment_method_<%= method.id %>"><%= method.name %></label>
                </div>
              <% end %>
            </div>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">請求書</label>
            <%= f.select :invoice_status,
                { '未発行': 'not_invoiced', '発行済み': 'invoiced' },
                { include_blank: '選択してください' },
                { class: 'form-select',
                  value: @search_params&.dig(:invoice_status) } %>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">請求締日</label>
            <%= f.select :billing_closing_day,
                options_for_select(Customer::BILLING_CLOSING_DAYS, @search_params&.dig(:billing_closing_day)),
                { include_blank: '選択してください' },
                { class: 'form-select' } %>
          </div>

          <!-- 検索ボタン -->
          <div class="col-12 mt-4 clear-left">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i> 検索
            </button>
            <%= link_to '検索条件クリア', orders_path, class: 'btn btn-outline-secondary ms-2' %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <form id="selected-orders-form" action="<%= new_invoice_path %>" method="get">
    <input type="hidden" name="order_ids" id="selected-order-ids" value="">

    <div class="text-left mt-4 mb-4">
      <button type="button" class="btn btn-success me-2" id="create-invoice-btn" disabled>選択した受注情報を合算して請求書を発行</button>
      <%= link_to 'CSVインポート', import_csv_orders_path, class: 'btn btn-success me-2' %>
      <%= link_to '新規受注', new_order_path, class: 'btn btn-primary' %>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th></th>
          <th>ID</th>
          <th>受注番号</th>
          <th>取引先</th>
          <th>受注日</th>
          <th>希望納品日</th>
          <th>確定納品日</th>
          <th>取引額</th>
          <th>支払い方法</th>
          <th>請求書</th>
          <th>操作</th>
        </tr>
      </thead>

      <tbody>
        <% @orders.each do |order| %>
          <tr>
            <td>
              <input type="checkbox" class="order-checkbox"
                    data-customer-id="<%= order.customer_id %>"
                    data-customer-name="<%= order.customer.company_name %>"
                    data-order-id="<%= order.id %>"
                    data-payment-method="<%= order.payment_method %>"
                    data-actual-delivery-date="<%= order.actual_delivery_date.present? %>"
                    data-invoiced="<%= order.invoiced? %>"
                    <%= 'disabled' if order.invoiced? %>>
            </td>
            <td><%= order.id %></td>
            <td><%= link_to order.order_number, order_path(order) %></td>
            <td><%= order.customer.company_name %></td>
            <td><%= l order.order_date %></td>
            <td><%= l order.expected_delivery_date if order.expected_delivery_date %></td>
            <td><%= l order.actual_delivery_date if order.actual_delivery_date %></td>
            <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal_without_tax }) %></td>
            <td><%= order.payment_method&.name %></td>
            <td>
              <% if order.invoiced? %>
                <%= link_to invoice_path(order.invoices.first), style: "text-decoration: none;" do %>
                  <span style="display: inline-block; padding: 0.25em 0.6em; font-size: 0.75rem; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; color: #fff; background-color: #28a745; cursor: pointer;">発行済</span>
                <% end %>
              <% else %>
                <span style="display: inline-block; padding: 0.25em 0.6em; font-size: 0.75rem; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; color: #fff; background-color: #6c757d;">未発行</span>
              <% end %>
            </td>
            <td>
              <%= link_to '詳細', order, class: 'btn btn-sm btn-info' %>
              <%= link_to '編集', edit_order_path(order), 
                         class: 'btn btn-sm btn-primary edit-order-btn',
                         data: { has_pending_or_approved_invoice: order.has_pending_or_approved_invoice? } %>
              <%= link_to '納品書', delivery_slip_order_path(order, format: :pdf),
                         class: 'btn btn-sm btn-success delivery-slip-btn',
                         target: '_blank',
                         data: { has_delivery_date: order.actual_delivery_date.present? } %>
              <%= form_with(url: order_path(order), method: :delete, class: 'd-inline') do |f| %>
                <%= f.submit '削除', class: 'btn btn-sm btn-danger', data: { confirm: '本当に削除しますか？' },
                            onclick: "return confirm('本当に削除しますか？');" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

  </form>

  <div class="d-flex justify-content-center">
    <%= paginate @orders %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    const createInvoiceBtn = document.getElementById('create-invoice-btn');
    const selectedOrderIdsInput = document.getElementById('selected-order-ids');
    const form = document.getElementById('selected-orders-form');

    // 納品書ボタンのクリックイベント
    const deliverySlipBtns = document.querySelectorAll('.delivery-slip-btn');
    deliverySlipBtns.forEach(btn => {
      btn.addEventListener('click', function(event) {
        const hasDeliveryDate = this.dataset.hasDeliveryDate === 'true';

        if (!hasDeliveryDate) {
          event.preventDefault();
          alert('確定納品日を入力してください');
          return false;
        }
      });
    });

    // 請求書発行ボタンのクリックイベント
    createInvoiceBtn.addEventListener('click', function(e) {
      const selectedOrders = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => ({
          id: cb.dataset.orderId,
          customerId: cb.dataset.customerId,
          paymentMethod: cb.dataset.paymentMethod,
          hasActualDeliveryDate: cb.dataset.actualDeliveryDate === 'true'
        }));

      // 確定納品日が未入力の受注がないかチェック
      const hasUnconfirmedDelivery = selectedOrders.some(order => !order.hasActualDeliveryDate);
      if (hasUnconfirmedDelivery) {
        e.preventDefault();
        alert('納品日が確定していない取引が含まれています');
        return false;
      }

      // 支払い方法の一意性をチェック
      const uniquePaymentMethods = new Set(selectedOrders.map(order => order.paymentMethod));

      if (uniquePaymentMethods.size > 1) {
        e.preventDefault();
        alert('複数の支払い方法の取引が選択されているため、発行できません');
        return false;
      }

      if (selectedOrders.length > 0) {
        selectedOrderIdsInput.value = selectedOrders.map(order => order.id).join(',');
        form.submit();
      }
    });

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const customerId = this.dataset.customerId;
        let anyChecked = false;
        let selectedCustomerId = null;
        const selectedOrderIds = [];

        // どのチェックボックスがチェックされているか確認
        checkboxes.forEach(cb => {
          if (cb.checked) {
            anyChecked = true;
            selectedCustomerId = cb.dataset.customerId;
            selectedOrderIds.push(cb.dataset.orderId);
          }
        });

        // チェックボックスがチェックされている場合、異なる取引先のチェックボックスを無効化
        if (anyChecked) {
          checkboxes.forEach(cb => {
            if (cb.dataset.customerId !== selectedCustomerId) {
              cb.disabled = true;
            }
          });
        } else {
          // チェックされていない場合、元々請求書発行済みで無効化されていないチェックボックスのみを有効化
          checkboxes.forEach(cb => {
            // 元々請求書発行済みで無効化されているチェックボックスは有効化しない
            if (cb.dataset.invoiced !== 'true') {
              cb.disabled = false;
            }
          });
        }

        // 選択されている受注があるか確認し、請求書発行ボタンの有効/無効を設定
        createInvoiceBtn.disabled = !anyChecked;

        // 選択された受注IDを隠しフィールドに設定
        selectedOrderIdsInput.value = selectedOrderIds.join(',');
      });
    });
    
    // 取引先名のインクリメンタルサーチを初期化
    if (window.CompanyNameSearch) {
      window.CompanyNameSearch.setup(document, {
        inputSelector: '#customer_name_search',
        suggestionsSelector: '#customer_name_suggestions',
        apiUrl: '/customers/company_name_search',
        autoSubmit: true
      });
    }
  });
</script>

<%= javascript_include_tag "/assets/javascripts/search_form.js" %>

<style>
.clear-left {
  clear: left;
}

/* ページネーションの番号の文字間隔を広げる - カスタムクラスを使用 */
.custom-page-link {
  padding: 0.5rem 0.75rem !important;
  margin: 0 0.125rem !important;
  letter-spacing: 0.15em !important;
  min-width: 2.5rem !important;
  text-align: center !important;
  display: inline-block !important;
  text-decoration: none !important;
  border: 1px solid #dee2e6 !important;
  border-radius: 0.375rem !important;
  color: #0d6efd !important;
  background-color: #fff !important;
  font-weight: 500 !important;
  transition: all 0.2s ease-in-out !important;
}

.pagination .page-item {
  margin: 0 0.125rem !important;
  display: inline-block !important;
}

/* アクティブなページ番号のスタイル */
.pagination .page-item.active .custom-page-link {
  background-color: #0d6efd !important;
  border-color: #0d6efd !important;
  color: #fff !important;
  letter-spacing: 0.15em !important;
  font-weight: 600 !important;
}

/* ホバー時のスタイル */
.custom-page-link:hover {
  background-color: #e9ecef !important;
  border-color: #dee2e6 !important;
  color: #0d6efd !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

/* 無効なページリンクのスタイル */
.pagination .page-item.disabled .custom-page-link {
  color: #6c757d !important;
  background-color: #f8f9fa !important;
  border-color: #dee2e6 !important;
  cursor: not-allowed !important;
  opacity: 0.6 !important;
}

/* ページネーション全体のスタイル */
.pagination {
  margin: 0 !important;
  padding: 0 !important;
  justify-content: center !important;
}
</style>