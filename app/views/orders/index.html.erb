<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>受注一覧</h1>
  </div>

  <%# 検索フォームを追加 %>
  <div class="card mb-4">
    <div class="card-header bg-light">
      <button class="btn btn-link btn-sm text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#searchCollapse" aria-expanded="false" aria-controls="searchCollapse">
        <i class="bi bi-search"></i> 検索条件
      </button>
    </div>
    <div class="collapse" id="searchCollapse">
      <div class="card-body">
        <%= form_with(url: orders_path, method: :get, local: true, id: 'search-form', class: 'row g-3') do |f| %>
          <!-- 1行目：顧客コード、取引先名、受注日、受注番号 -->
          <div class="col-md-2 me-3">
            <label class="form-label">顧客コード</label>
            <%= f.text_field :customer_code,
                value: @search_params&.dig(:customer_code),
                class: 'form-control',
                placeholder: '半角英数' %>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">顧客名</label>
            <select id="customer_name_search" name="customer_name" class="form-select">
              <option value="">選択してください</option>
              <% @customers.each do |customer| %>
                <option value="<%= customer.company_name %>" data-customer-code="<%= customer.customer_code %>" data-customer-id="<%= customer.id %>" <%= 'selected' if @search_params&.dig(:customer_name) == customer.company_name %>>
                  <%= customer.company_name %>
                </option>
              <% end %>
            </select>
          </div>

          <div class="col-md-4 me-3">
            <label class="form-label">受注日</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= f.date_field :order_date_from,
                    value: @search_params&.dig(:order_date_from),
                    class: 'form-control', placeholder: 'From' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= f.date_field :order_date_to,
                    value: @search_params&.dig(:order_date_to),
                    class: 'form-control', placeholder: 'To' %>
              </div>
            </div>
          </div>

          <div class="col-md-2 me-3">
            <label class="form-label">受注番号</label>
            <%= f.text_field :order_number,
                value: @search_params&.dig(:order_number),
                class: 'form-control' %>
          </div>

          <!-- 2行目：希望納品日、確定納品日、合計金額（範囲検索） -->
          <div class="col-md-4 me-3 clear-left">
            <label class="form-label">希望納品日</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= f.date_field :expected_delivery_date_from,
                    value: @search_params&.dig(:expected_delivery_date_from),
                    class: 'form-control', placeholder: 'From' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= f.date_field :expected_delivery_date_to,
                    value: @search_params&.dig(:expected_delivery_date_to),
                    class: 'form-control', placeholder: 'To' %>
              </div>
            </div>
          </div>

          <div class="col-md-4 me-3">
            <label class="form-label">確定納品日</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= f.date_field :actual_delivery_date_from,
                    value: @search_params&.dig(:actual_delivery_date_from),
                    class: 'form-control', placeholder: 'From' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= f.date_field :actual_delivery_date_to,
                    value: @search_params&.dig(:actual_delivery_date_to),
                    class: 'form-control', placeholder: 'To' %>
              </div>
            </div>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">合計金額（税抜）</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= f.number_field :total_without_tax_from,
                    value: @search_params&.dig(:total_without_tax_from),
                    class: 'form-control', placeholder: '最低金額' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= f.number_field :total_without_tax_to,
                    value: @search_params&.dig(:total_without_tax_to),
                    class: 'form-control', placeholder: '最高金額' %>
              </div>
            </div>
          </div>

          <!-- 3行目：支払方法（チェックボックス複数選択）と請求書ステータス -->
          <div class="col-md-4 me-2 clear-left">
            <label class="form-label">支払い方法</label>
            <div class="d-flex flex-wrap">
              <% @payment_methods.each do |method| %>
                <div class="form-check me-3">
                  <%= check_box_tag "payment_method_ids[]", method.id,
                      (@search_params&.dig(:payment_method_ids) || []).include?(method.id.to_s),
                      { class: 'form-check-input', id: "payment_method_#{method.id}" } %>
                  <label class="form-check-label" for="payment_method_<%= method.id %>"><%= method.name %></label>
                </div>
              <% end %>
            </div>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">請求書</label>
            <%= f.select :invoice_status,
                { '未発行': 'not_invoiced', '発行済み': 'invoiced' },
                { include_blank: '選択してください' },
                { class: 'form-select',
                  value: @search_params&.dig(:invoice_status) } %>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">請求締日</label>
            <%= f.select :billing_closing_day,
                options_for_select(Customer::BILLING_CLOSING_DAYS, @search_params&.dig(:billing_closing_day)),
                { include_blank: '選択してください' },
                { class: 'form-select' } %>
          </div>

          <!-- 検索ボタン -->
          <div class="col-12 mt-4 clear-left">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i> 検索
            </button>
            <%= link_to '検索条件クリア', orders_path, class: 'btn btn-outline-secondary ms-2' %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <form id="selected-orders-form" action="<%= new_invoice_path %>" method="get">
    <input type="hidden" name="order_ids" id="selected-order-ids" value="">

    <div class="text-left mt-4 mb-4">
      <button type="button" class="btn btn-success me-2" id="create-invoice-btn" disabled>選択した受注情報を合算して請求書を発行</button>
      <%= link_to 'CSVインポート', import_csv_orders_path, class: 'btn btn-success me-2' %>
      <%= link_to '新規受注', new_order_path, class: 'btn btn-primary' %>
    </div>

    <div class="table-responsive">
      <table class="table orders-index-table" style="table-layout: fixed; width: 100%;">
        <thead>
          <tr>
            <th class="text-center" style="width: 30px;"></th>
            <th class="text-center" style="width: 130px;">受注番号</th>
            <th class="text-center" style="width: 220px;">顧客名</th>
            <th class="text-center" style="width: 70px;">注文元</th>
            <th class="text-center" style="width: 110px;">受注日</th>
            <th class="text-center" style="width: 110px;">希望納品日</th>
            <th class="text-center" style="width: 110px;">確定納品日</th>
            <th class="text-center" style="width: 110px;">受注金額</th>
            <th class="text-center" style="width: 140px;">支払い方法</th>
            <th class="text-center" style="width: 70px;">請求書</th>
            <th class="text-center" style="width: 160px;">操作</th>
          </tr>
        </thead>

        <tbody>
          <% @orders.each do |order| %>
            <tr>
              <td>
                <input type="checkbox" class="order-checkbox"
                      data-customer-id="<%= order.customer_id %>"
                      data-customer-name="<%= order.customer.company_name %>"
                      data-order-id="<%= order.id %>"
                      data-payment-method="<%= order.payment_method %>"
                      data-actual-delivery-date="<%= order.actual_delivery_date.present? %>"
                      data-invoiced="<%= order.invoiced? %>"
                      <%= 'disabled' if order.invoiced? %>>
              </td>
              <td><small><%= link_to order.order_number, order_path(order) %></small></td>
              <td><small><%= order.customer.company_name %></small></td>
              <td>
                <span class="<%= order_source_badge_class(order.is_shop_order?) %>"><%= order_source_badge_text(order.is_shop_order?) %></span>
              </td>
              <td class="text-end date-monospace"><small><%= l order.order_date %></small></td>
              <td class="text-end date-monospace"><small><%= l order.expected_delivery_date if order.expected_delivery_date %></small></td>
              <td class="text-end date-monospace"><small><%= l order.actual_delivery_date if order.actual_delivery_date %></small></td>
              <td class="text-end"><small><%= number_to_currency(order.order_items.sum { |item| item.subtotal_without_tax }) %></small></td>
              <td><small><%= order.payment_method&.name %></small></td>
              <td>
                <%= render 'shared/invoice_status_badge', order: order %>
              </td>
              <td>
                <div class="d-flex gap-1">
                  <%= link_to order_path(order), class: 'btn btn-sm btn-info', title: '詳細' do %>
                    <i class="bi bi-eye"></i>
                  <% end %>
                  <%= link_to edit_order_path(order),
                             class: 'btn btn-sm btn-primary edit-order-btn',
                             title: '編集',
                             data: { has_pending_or_approved_invoice: order.has_pending_or_approved_invoice? } do %>
                    <i class="bi bi-pencil"></i>
                  <% end %>
                  <%= link_to delivery_slip_order_path(order, format: :pdf),
                             class: 'btn btn-sm btn-success delivery-slip-btn',
                             title: '納品書',
                             target: '_blank',
                             data: { has_delivery_date: order.actual_delivery_date.present? } do %>
                    <i class="bi bi-file-earmark-text"></i>
                  <% end %>
                  <% confirm_msg = t('confirms.destroy', default: '本当に削除しますか？') %>
                  <%= button_to order_path(order),
                                  method: :delete,
                                  form: { data: { turbo_confirm: confirm_msg },
                                          class: 'd-inline' },
                                  class: 'btn btn-sm btn-danger',
                                  title: '削除' do %>
                    <i class="bi bi-trash"></i>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

  </form>

  <%= render 'shared/pagination', collection: @orders %>
</div>

<%= javascript_include_tag "/assets/javascripts/search_form.js" %>
<%= javascript_include_tag "orders/index" %>