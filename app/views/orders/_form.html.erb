<div class="order-form-container">
  <%= form_with(model: @order, local: true, class: "order-form") do |f| %>
    <% if @order.errors.any? %>
      <div id="error_explanation" class="alert alert-danger">
        <h2><%= pluralize(@order.errors.count, "つのエラー") %> があります:</h2>
        <ul>
          <% @order.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">基本情報</h5>
        <% if @order.persisted? && @order.is_shop_order? %>
          <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i> この注文はネットショップから登録されました。
          </div>
        <% end %>
        <div class="row">
          <div class="col-md-3 form-group">
            <%= f.label :customer_code, "顧客コード" %>
            <%= text_field_tag :customer_code, @customer_code, class: "form-control", id: "order_customer_code", placeholder: "顧客コードを入力" %>
          </div>

          <div class="col-md-3 form-group">
            <%= f.label :customer_id do %>
              顧客名<span class="text-danger">*</span>
            <% end %>
            <%= f.hidden_field :customer_id, id: "order_customer_id" %>
            <select id="order_customer_select" name="order[customer_id]" class="form-select" required>
              <option value="">選択してください</option>
              <% (@customers || Customer.order(:company_name)).each do |customer| %>
                <option value="<%= customer.id %>" data-customer-code="<%= customer.customer_code %>" <%= 'selected' if @order.customer_id == customer.id %>>
                  <%= customer.company_name %>
                </option>
              <% end %>
            </select>
          </div>

          <div class="col-md-3 form-group">
            <%= f.label :order_date, "受注日" do %>
              受注日<span class="text-danger">*</span>
            <% end %>
            <%= f.date_field :order_date, class: "form-control", required: true %>
          </div>

          <div class="col-md-3 form-group">
            <%= f.label :payment_method_id do %>
              支払い方法<span class="text-danger">*</span>
            <% end %>
            <%= f.collection_select :payment_method_id,
                @payment_methods,
                :id,
                :name,
                { include_blank: true },
                { class: "form-select", required: true } %>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">納品情報</h5>
        <div class="row">
          <div class="col-md-4 form-group">
            <%= f.label :delivery_location_id do %>
              納品先<span class="text-danger">*</span>
            <% end %>
            <%= f.collection_select :delivery_location_id,
                @delivery_locations || [],
                :id,
                :display_name,
                { include_blank: true, selected: @order.delivery_location_id || (@delivery_locations&.find(&:is_main_office)&.id || @delivery_locations&.first&.id) },
                { class: "form-select", required: true, disabled: @delivery_locations.blank?, id: "order_delivery_location_id" } %>
            <% if @delivery_locations.blank? %>
              <small class="form-text text-muted">先に顧客名を選択してください</small>
            <% end %>
          </div>
          <div class="col-md-4 form-group">
            <%= f.label :expected_delivery_date, "希望納品日" %>
            <%= f.date_field :expected_delivery_date, class: "form-control" %>
            <small class="form-text text-muted">希望納品日または確定納品日のいずれかを入力してください</small>
          </div>
          <div class="col-md-4 form-group">
            <%= f.label :actual_delivery_date, "確定納品日" %>
            <%= f.date_field :actual_delivery_date, class: "form-control" %>
            <small class="form-text text-muted">希望納品日または確定納品日のいずれかを入力してください</small>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">注文明細</h5>
        <table class="table order-item-table" id="order-items">
          <colgroup>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
          </colgroup>
          <thead>
            <tr>
              <th>商品コード</th>
              <th>商品</th>
              <th>規格</th>
              <th>単価</th>
              <th>税率</th>
              <th>数量</th>
              <th>単位</th>
              <th>税抜</th>
              <th>税込</th>
              <th>備考</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <%= f.fields_for :order_items do |item_form| %>
              <%= render 'order_item_fields', f: item_form %>
            <% end %>
            <% if f.object.order_items.empty? %>
              <% new_item = OrderItem.new(quantity: nil) %>
              <%= f.fields_for :order_items, new_item, child_index: Time.now.to_i do |item_form| %>
                <%= render 'order_item_fields', f: item_form %>
              <% end %>
            <% end %>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="7" class="text-end"><strong>合計（税抜）：</strong></td>
              <td>
                <strong><span id="order-total-without-tax" class="d-inline-block text-end order-total-amount">0円</span></strong>
              </td>
              <td colspan="2"></td>
            </tr>
            <tr>
              <td colspan="7" class="text-end"><strong>合計（税込）：</strong></td>
              <td></td>
              <td>
                <strong><span id="order-total-with-tax" class="d-inline-block text-end order-total-amount">0円</span></strong>
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>

        <div class="links mb-3">
          <%= link_to '商品を追加', '#', class: 'btn btn-outline-primary add-item' %>
        </div>
      </div>
    </div>

    <div class="actions">
      <%= f.submit @order.persisted? ? "更新" : "登録", class: "btn btn-sm btn-success" %>
    </div>
  <% end %>
</div>

<%= javascript_include_tag "orders/form" %>