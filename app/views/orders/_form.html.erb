<div class="order-form-container">
  <%= form_with(model: @order, local: true, class: "order-form") do |f| %>
    <% if @order.errors.any? %>
      <div id="error_explanation" class="alert alert-danger">
        <h2><%= pluralize(@order.errors.count, "つのエラー") %> があります:</h2>
        <ul>
          <% @order.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">基本情報</h5>
        <div class="row">
          <div class="col-md-4 form-group">
            <%= f.label :customer_id, "取引先" %>
            <%= f.collection_select :customer_id,
                @customers,
                :id,
                :company_name,
                { include_blank: "取引先を選択してください" },
                { class: "form-control", required: true, id: "order_customer_id" } %>
          </div>

          <div class="col-md-4 form-group">
            <%= f.label :order_date, "受注日" %>
            <%= f.date_field :order_date, class: "form-control", required: true %>
          </div>

          <div class="col-md-4 form-group">
            <%= f.label :payment_method_id, "支払い方法" %>
            <%= f.collection_select :payment_method_id,
                @payment_methods,
                :id,
                :name,
                { include_blank: "支払い方法を選択してください" },
                { class: "form-control" } %>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">納品情報</h5>
        <div class="row">
          <div class="col-md-6 form-group">
            <%= f.label :delivery_location_id, "納品先" %>
            <%= f.collection_select :delivery_location_id,
                @delivery_locations || [],
                :id,
                :name,
                { include_blank: "納品先を選択してください" },
                { class: "form-control", required: true, disabled: @delivery_locations.blank? } %>
            <% if @delivery_locations.blank? %>
              <small class="form-text text-muted">先に取引先を選択してください</small>
            <% end %>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 form-group">
            <%= f.label :expected_delivery_date, "予定納品日" %>
            <%= f.date_field :expected_delivery_date, class: "form-control" %>
          </div>

          <div class="col-md-6 form-group">
            <%= f.label :actual_delivery_date, "確定納品日" %>
            <%= f.date_field :actual_delivery_date, class: "form-control" %>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">注文明細</h5>
        <table class="table" id="order-items" style="table-layout: fixed;">
          <thead>
            <tr>
              <th style="width: 180px;">商品</th>
              <th style="width: 100px;">単価</th>
              <th style="width: 80px;">税率</th>
              <th style="width: 70px;">数量</th>
              <th style="width: 70px;">単位</th>
              <th style="width: 100px;">税抜金額</th>
              <th style="width: 100px;">税込金額</th>
              <th style="width: 150px;">備考</th>
              <th style="width: 70px;"></th>
            </tr>
          </thead>
          <tbody>
            <%= f.fields_for :order_items do |item_form| %>
              <%= render 'order_item_fields', f: item_form %>
            <% end %>
            <% if (!f.object.persisted? && !f.object.order_items.present?) || f.object.order_items.empty? %>
              <%= f.fields_for :order_items, OrderItem.new, child_index: Time.now.to_i do |item_form| %>
                <%= render 'order_item_fields', f: item_form %>
              <% end %>
            <% end %>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="5" class="text-right"><strong>合計（税抜）：</strong></td>
              <td>
                <strong><span id="order-total-without-tax" style="display: inline-block; min-width: 80px; text-align: right;">0</span>円</strong>
              </td>
              <td colspan="2"></td>
            </tr>
            <tr>
              <td colspan="5" class="text-right"><strong>合計（税込）：</strong></td>
              <td></td>
              <td>
                <strong><span id="order-total-with-tax" style="display: inline-block; min-width: 80px; text-align: right;">0</span>円</strong>
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>

        <div class="links mb-3">
          <%= link_to '商品を追加', '#', class: 'btn btn-outline-primary add-item' %>
        </div>
      </div>
    </div>

    <div class="actions">
      <%= f.submit @order.persisted? ? "更新" : "登録", class: "btn btn-success" %>
    </div>
  <% end %>
</div>

<%# 納品先選択機能のJavaScript %>
<script>
$(document).ready(function() {
  console.log('納品先選択機能の初期化を開始します（フォーム内）');

  // 顧客選択時のイベント処理
  $('#order_customer_id').on('change', function() {
    var customerId = $(this).val();
    console.log('顧客が選択されました - ID:', customerId);

    var select = $('#order_delivery_location_id');
    console.log('納品先セレクトボックスを取得:', select.length ? '成功' : '失敗');

    if (customerId) {
      // 納品先を取得するAPIリクエスト
      var url = '/customers/' + customerId + '/delivery_locations';
      console.log('APIリクエストを送信します:', url);

      // リクエスト中は選択できないようにする
      select.prop('disabled', true).empty().append('<option value="">読み込み中...</option>');

      $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json',
        success: function(data) {
          console.log('納品先データを取得しました:', data);

          // セレクトボックスをクリアして再構築
          select.empty().append('<option value="">納品先を選択してください</option>');

          if (data && data.length > 0) {
            // 納品先オプションを追加
            $.each(data, function(index, location) {
              select.append('<option value="' + location.id + '">' + location.name + '</option>');
            });

            // 選択可能にする
            select.prop('disabled', false);
            console.log('納品先オプションを追加しました');
          } else {
            // 納品先がない場合
            select.append('<option value="">納品先がありません</option>');
            select.prop('disabled', true);
            console.log('納品先データが空でした');
          }
        },
        error: function(xhr, status, error) {
          console.error('納品先の取得に失敗しました');
          console.error('ステータス:', status);
          console.error('エラー:', error);
          console.error('レスポンス:', xhr.responseText);

          // エラー時の処理
          select.empty().append('<option value="">取得できませんでした</option>');
          select.prop('disabled', true);
        }
      });
    } else {
      // 顧客が選択されていない場合、納品先選択肢をクリア
      select.empty().append('<option value="">納品先を選択してください</option>');
      select.prop('disabled', true);
      console.log('顧客が選択されていないため、納品先をクリアしました');
    }
  });

  console.log('納品先選択機能の初期化が完了しました（フォーム内）');
});
</script>

<%# jQuery実装の動作確認用 %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('フォーム読み込み完了 - jQuery版の動作を確認します');
    // 計算関数は外部ファイル order_calculations.js に移動しました
  });
</script>