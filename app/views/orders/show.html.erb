<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>受注詳細</h1>
    <div>
      <%= link_to '編集', edit_order_path(@order),
                 class: 'btn btn-sm btn-primary edit-order-btn',
                 data: { has_pending_or_approved_invoice: @order.has_pending_or_approved_invoice? } %>
      <%= render 'shared/show_action_buttons',
                  edit_path: nil,
                  delete_path: order_path(@order),
                  back_path: orders_path %>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-light">
      <h2 class="card-title mb-0">基本情報</h2>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-3">
          <strong>受注番号:</strong>
          <%= @order.order_number %>
        </div>
        <div class="col-md-4">
          <strong>請求書:</strong>
          <% if @order.invoiced? %>
            <%= @order.related_invoices %>
          <% end %>
          <%= render 'shared/invoice_status_badge', order: @order %>
        </div>
        <div class="col-md-5">
          <strong>注文元:</strong>
          <% if @order.is_shop_order? %>
            <span class="badge bg-success">ネットショップ</span>
          <% else %>
            <span class="badge bg-secondary">管理画面</span>
          <% end %>
        </div>
      </div>
      <div class="row">
        <div class="col-md-3">
          <strong>顧客コード:</strong>
          <%= @order.customer.customer_code %>
        </div>
        <div class="col-md-3">
          <strong>顧客名:</strong>
          <%= @order.customer.company_name %>
        </div>
        <div class="col-md-6">
          <strong>受注日:</strong>
          <%= l @order.order_date %>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-md-6">
          <strong>支払い方法:</strong>
          <%= @order.payment_method&.name || '未設定' %>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-md-12">
          <%= render 'shared/delivery_slip_button',
                      order: @order,
                      text: '納品書PDF発行',
                      id: 'delivery-slip-btn',
                      tooltip: true %>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-light">
      <h2 class="card-title mb-0">納品情報</h2>
    </div>
    <div class="card-body">
      <% if @order.delivery_location.present? %>
        <div class="row mb-3">
          <div class="col-md-12">
            <strong>納品先:</strong>
            <%= @order.delivery_location.name %>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-12">
            <strong>納品先住所:</strong>
            〒<%= @order.delivery_location.postal_code %> <%= @order.delivery_location.address %>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>電話番号:</strong>
            <%= @order.delivery_location.phone %>
          </div>
          <div class="col-md-6">
            <strong>担当者:</strong>
            <%= @order.delivery_location.contact_person %>
          </div>
        </div>
      <% else %>
        <div class="row mb-3">
          <div class="col-md-12">
            <span class="text-muted">納品先情報がありません</span>
          </div>
        </div>
      <% end %>
      <div class="row">
        <div class="col-md-6">
          <strong>希望納品日:</strong>
          <%= l @order.expected_delivery_date if @order.expected_delivery_date %>
        </div>
        <div class="col-md-6">
          <strong>確定納品日:</strong>
          <%= l @order.actual_delivery_date if @order.actual_delivery_date %>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-light">
      <h2 class="card-title mb-0">注文明細</h2>
    </div>
    <div class="card-body">
      <table class="table">
        <thead>
          <tr>
            <th>商品名</th>
            <th>規格</th>
            <th class="text-end">単価（税抜）</th>
            <th class="text-end">税率（%）</th>
            <th class="text-end">数量</th>
            <th class="text-end">単位</th>
            <th class="text-end">小計（税抜）</th>
            <th class="text-end">小計（税込）</th>
            <th>備考</th>
          </tr>
        </thead>
        <tbody>
          <% @order.order_items.each do |item| %>
            <tr>
              <td><%= item.display_product_name %></td>
              <td><%= item.display_product_specification_name %></td>
              <td class="text-end"><%= number_to_currency(item.unit_price, precision: 2, strip_insignificant_zeros: true, unit: '') %>円</td>
              <td class="text-end"><%= item.tax_rate %>%</td>
              <td class="text-end"><%= number_with_precision(item.quantity, precision: 3, strip_insignificant_zeros: true) %></td>
              <td class="text-end"><%= item.unit&.name %></td>
              <td class="text-end"><%= item.product.is_discount_target? ? '-' : '' %><%= number_to_currency(item.subtotal_without_tax.abs, precision: 0) %></td>
              <td class="text-end"><%= item.product.is_discount_target? ? '-' : '' %><%= number_to_currency(item.subtotal.abs, precision: 0) %></td>
              <td><%= item.notes %></td>
            </tr>
          <% end %>
          <tr>
            <td><strong>合計（税抜）:</strong></td>
            <td colspan="5"></td>
            <td class="text-end"><strong><%= number_to_currency(@order.order_items.sum { |item| item.subtotal_without_tax }, precision: 0) %></strong></td>
            <td colspan="2"></td>
          </tr>
          <tr>
            <td><strong>合計（税込）:</strong></td>
            <td colspan="6"></td>
            <td class="text-end"><strong><%= number_to_currency(@order.order_items.sum { |item| item.subtotal }, precision: 0) %></strong></td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="text-center mb-4">
    <%= link_to '編集', edit_order_path(@order),
               class: 'btn btn-sm btn-primary edit-order-btn',
               data: { has_pending_or_approved_invoice: @order.has_pending_or_approved_invoice? } %>
    <%= render 'shared/show_action_buttons',
                edit_path: nil,
                delete_path: order_path(@order),
                back_path: orders_path %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 納品書ボタンのクリックイベント（一覧ページと同じ処理）
    const deliverySlipBtns = document.querySelectorAll('.delivery-slip-btn');
    deliverySlipBtns.forEach(btn => {
      btn.addEventListener('click', function(event) {
        const hasDeliveryDate = this.dataset.hasDeliveryDate === 'true';

        if (!hasDeliveryDate) {
          event.preventDefault();
          alert('確定納品日を入力してください');
          return false;
        }
      });
    });
  });
</script>