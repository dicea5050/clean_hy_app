<div class="container">
  <h1>新規請求書発行</h1>

  <%= form_with(model: @invoice, local: true) do |form| %>
    <% if @invoice.errors.any? %>
      <div class="alert alert-danger">
        <h2><%= pluralize(@invoice.errors.count, "エラー") %> が発生しました:</h2>
        <ul>
          <% @invoice.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= hidden_field_tag :order_ids, @order_ids.join(',') if @order_ids.present? %>
    
    <% if @orders.present? && @invoice.customer_id.present? %>
      <%= form.hidden_field :customer_id %>
    <% end %>

    <div class="row mb-3">
      <div class="col-md-4">
        <div class="form-group">
          <%= form.label :customer_id, '取引先' %>
          <%= form.collection_select :customer_id, @customers, :id, :company_name, 
                                    { prompt: '取引先を選択してください', selected: @invoice.customer_id }, 
                                    { class: 'form-control', disabled: @orders.present? } %>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="form-group">
          <%= form.label :invoice_date, '請求日' %>
          <%= form.date_field :invoice_date, class: 'form-control' %>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="form-group">
          <%= form.label :due_date, '支払期限' %>
          <%= form.date_field :due_date, class: 'form-control' %>
        </div>
      </div>
    </div>

    <div class="form-group mb-3">
      <%= form.label :notes, '備考' %>
      <%= form.text_area :notes, class: 'form-control' %>
    </div>

    <% if @orders.present? %>
      <h3>選択された受注情報</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>確定納品日</th>
            <th>受注番号</th>
            <th>商品</th>
            <th>数量</th>
            <th>小計（税抜）</th>
            <th>小計（税込）</th>
          </tr>
        </thead>
        <tbody>
          <% current_order_id = nil %>
          <% @orders.each do |order| %>
            <% order.order_items.each_with_index do |item, index| %>
              <tr>
                <td>
                  <% if current_order_id != order.id %>
                    <%= l order.actual_delivery_date if order.actual_delivery_date %>
                  <% end %>
                </td>
                <td>
                  <% if current_order_id != order.id %>
                    <%= order.order_number %>
                  <% end %>
                </td>
                <td><%= item.display_product_name %></td>
                <td><%= item.quantity %></td>
                <td class="text-right"><%= number_to_currency(item.subtotal_without_tax) %></td>
                <td class="text-right"><%= number_to_currency(item.subtotal) %></td>
              </tr>
              <% current_order_id = order.id %>
            <% end %>
          <% end %>
          <tr class="table-info">
            <td colspan="4"><strong>合計</strong></td>
            <td class="text-right">
              <strong><%= number_to_currency(@orders.sum { |order| order.order_items.sum(&:subtotal_without_tax) }) %></strong>
            </td>
            <td class="text-right">
              <strong><%= number_to_currency(@orders.sum { |order| order.order_items.sum(&:subtotal) }) %></strong>
            </td>
          </tr>
        </tbody>
      </table>
    <% else %>
      <div class="alert alert-warning">
        選択された受注情報がありません。受注一覧画面から受注を選択してください。
      </div>
    <% end %>

    <div class="form-group text-center mt-4">
      <%= form.submit '請求書を発行する', class: 'btn btn-primary', disabled: @orders.blank? %>
      <%= link_to '戻る', orders_path, class: 'btn btn-secondary' %>
    </div>
  <% end %>
</div> 