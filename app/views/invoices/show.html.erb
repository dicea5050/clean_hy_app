<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>請求情報詳細</h1>
    <div>
      <%= render 'shared/invoice_pdf_button', invoice: @invoice %>
      <%= render 'shared/invoice_receipt_button', invoice: @invoice, modal_id: 'receiptModal' %>
      <% if @invoice.approval_status == Invoice::APPROVAL_STATUSES[:approved] %>
        <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-sm btn-primary edit-approved-invoice',
                    data: { invoice_id: @invoice.id, approval_status: @invoice.approval_status } %>
      <% else %>
        <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-sm btn-primary' %>
      <% end %>
      <%= render 'shared/show_action_buttons',
                  edit_path: nil,
                  delete_path: nil,
                  back_path: invoices_path %>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-light">
      <h2 class="card-title mb-0">
        <%= @invoice.invoice_number %>
        <%= render 'shared/approval_status_badge', invoice: @invoice, margin_class: 'ms-2' %>
        <%= render 'shared/payment_status_badge', object: @invoice, margin_class: 'ms-2' %>
      </h2>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <div class="d-flex align-items-center">
            <strong class="me-2">顧客名:</strong>
            <span><%= @invoice.customer.company_name %></span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="d-flex align-items-center">
            <strong class="me-2">請求日:</strong>
            <span><%= l @invoice.invoice_date %></span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="d-flex align-items-center">
            <strong class="me-2">支払期限:</strong>
            <span><%= l @invoice.due_date if @invoice.due_date %></span>
          </div>
        </div>
      </div>

      <%
        # 請求金額（税込）
        request_amount = @invoice.total_amount
        # 繰越金額
        carryover_amount = @carryover_amount || 0
        # 請求合計金額
        total_request_amount = request_amount + carryover_amount
      %>
      <div class="row mt-3">
        <div class="col-md-3">
          <div class="card">
            <div class="card-body d-flex justify-content-between align-items-center py-2">
              <span class="mb-0">請求金額</span>
              <span class="h4 text-primary mb-0">
                <%= number_to_currency(request_amount) %>
              </span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body d-flex justify-content-between align-items-center py-2">
              <span class="mb-0">繰越金額</span>
              <span class="h4 text-warning mb-0">
                <%= number_to_currency(carryover_amount) %>
              </span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body d-flex justify-content-between align-items-center py-2">
              <span class="mb-0">請求合計金額</span>
              <span class="h4 text-success mb-0">
                <%= number_to_currency(total_request_amount) %>
              </span>
            </div>
          </div>
        </div>
      </div>

      <% if @invoice.notes.present? %>
        <div class="row mt-3">
          <div class="col-12">
            <h3>備考</h3>
            <p><%= simple_format @invoice.notes %></p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%= render 'rejection_reason' %>

  <h2>対象受注</h2>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>受注番号</th>
        <th>受注日</th>
        <th>確定納品日</th>
        <th>合計金額（税抜）</th>
        <th>合計金額（税込）</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @invoice.orders.each do |order| %>
        <tr>
          <td><%= link_to order.order_number, order_path(order) %></td>
          <td><%= l order.order_date %></td>
          <td><%= l order.actual_delivery_date if order.actual_delivery_date %></td>
          <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal_without_tax }) %></td>
          <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal }) %></td>
          <td>
            <%= link_to '詳細', order_path(order), class: 'btn btn-sm btn-info' %>
          </td>
        </tr>
      <% end %>
      <tr class="table-info">
        <td colspan="3"><strong>合計</strong></td>
        <td><strong><%= number_to_currency(@invoice.total_amount_without_tax) %></strong></td>
        <td><strong><%= number_to_currency(@invoice.total_amount) %></strong></td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <!-- 送付履歴セクション -->
  <div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h2 class="card-title mb-0">送付履歴</h2>
      <% if @invoice.approval_status == Invoice::APPROVAL_STATUSES[:approved] %>
        <% if @invoice.customer.electronic? %>
          <% if @invoice.email_pending? %>
            <%= button_to send_email_invoice_path(@invoice),
                          method: :post,
                          class: 'btn btn-sm btn-success',
                          form: { data: { turbo_confirm: "請求書 #{@invoice.invoice_number} をメール送信しますか？" },
                                  class: 'd-inline' } do %>
              <i class="bi bi-envelope"></i> メール送信
            <% end %>
          <% elsif @invoice.email_sent? %>
            <button type="button" 
                    class="btn btn-sm btn-warning" 
                    data-bs-toggle="modal" 
                    data-bs-target="#resendModal"
                    title="再送信">
              <i class="bi bi-envelope-arrow-up"></i> 再送信
            </button>
          <% end %>
        <% elsif @invoice.customer.postal? %>
          <% if !@invoice.pdf_downloaded? %>
            <%= button_to mark_printed_invoice_path(@invoice),
                          method: :post,
                          class: 'btn btn-sm btn-primary',
                          form: { data: { turbo_confirm: "請求書 #{@invoice.invoice_number} を印刷済みとしてマークしますか？" },
                                  class: 'd-inline' } do %>
              <i class="bi bi-printer"></i> 印刷済みマーク
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </div>
    <div class="card-body">
      <% if @invoice.invoice_deliveries.any? %>
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>送付日時</th>
                <th>送付方法</th>
                <th>ステータス</th>
                <th>送付者</th>
                <th>再送信</th>
                <th>備考</th>
              </tr>
            </thead>
            <tbody>
              <% @invoice.invoice_deliveries.recent.each do |delivery| %>
                <tr>
                  <td><%= delivery.sent_at ? l(delivery.sent_at, format: :long) : '-' %></td>
                  <td>
                    <% if delivery.delivery_method == InvoiceDelivery::DELIVERY_METHODS[:email] %>
                      <span class="badge bg-info">電子請求</span>
                    <% else %>
                      <span class="badge bg-secondary">郵送</span>
                    <% end %>
                  </td>
                  <td>
                    <% case delivery.delivery_status
                       when InvoiceDelivery::DELIVERY_STATUSES[:sent] %>
                      <span class="badge bg-success">送付済み</span>
                    <% when InvoiceDelivery::DELIVERY_STATUSES[:downloaded] %>
                      <span class="badge bg-info">ダウンロード済み</span>
                    <% when InvoiceDelivery::DELIVERY_STATUSES[:printed] %>
                      <span class="badge bg-primary">印刷済み</span>
                    <% else %>
                      <span class="badge bg-warning">未送付</span>
                    <% end %>
                  </td>
                  <td>
                    <% if delivery.sender %>
                      <%= delivery.sender.email %>
                    <% else %>
                      -
                    <% end %>
                  </td>
                  <td>
                    <% if delivery.is_resend? %>
                      <span class="badge bg-warning">再送信</span>
                    <% else %>
                      <span class="text-muted">初回</span>
                    <% end %>
                  </td>
                  <td><%= delivery.notes.presence || '-' %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted text-center py-4">送付履歴はありません</p>
      <% end %>
    </div>
  </div>

  <!-- 入金履歴セクション -->
  <div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h2 class="card-title mb-0">入金履歴</h2>
      <%= link_to '入金登録', payment_management_index_path, class: 'btn btn-sm btn-primary' %>
    </div>
    <div class="card-body">
      <% if @payment_records.any? %>
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>入金日</th>
                <th>入金ID</th>
                <th>入金種別</th>
                <th class="text-end">入金額</th>
                <th class="text-end">充当額</th>
                <th>備考</th>
              </tr>
            </thead>
            <tbody>
              <% @payment_records.each do |payment_record| %>
                <tr>
                  <td><%= l payment_record.payment_date %></td>
                  <td><%= payment_record.id %></td>
                  <td><%= payment_record.category %></td>
                  <td class="text-end"><%= number_to_currency(payment_record.amount) %></td>
                  <td class="text-end"><%= number_to_currency(payment_record.paid_amount) %></td>
                  <td><%= payment_record.notes.presence || '-' %></td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr class="table-info">
                <td colspan="3"><strong>合計</strong></td>
                <td class="text-end"><strong><%= number_to_currency(@payment_records.sum(:amount)) %></strong></td>
                <td class="text-end"><strong><%= number_to_currency(@payment_records.sum(:paid_amount)) %></strong></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      <% else %>
        <p class="text-muted text-center py-4">入金履歴はありません</p>
      <% end %>
    </div>
  </div>

  <div class="text-center mt-4 mb-3">
    <%= render 'shared/invoice_pdf_button', invoice: @invoice %>
    <%= render 'shared/invoice_receipt_button', invoice: @invoice, modal_id: 'receiptModal' %>
    <% if @invoice.approval_status == Invoice::APPROVAL_STATUSES[:approved] %>
      <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-sm btn-primary edit-approved-invoice',
                  data: { invoice_id: @invoice.id, approval_status: @invoice.approval_status } %>
    <% else %>
      <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-sm btn-primary' %>
    <% end %>
    <%= render 'shared/show_action_buttons',
                edit_path: nil,
                delete_path: nil,
                back_path: invoices_path %>
  </div>
</div>

<!-- 領収書発行モーダル -->
<%= render 'shared/invoice_receipt_modal', invoice: @invoice, modal_id: 'receiptModal' %>

<!-- 再送信モーダル -->
<% if @invoice.email_sent? %>
  <div class="modal fade" id="resendModal" tabindex="-1" aria-labelledby="resendModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resendModalLabel">メール再送信</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <%= form_with url: send_email_invoice_path(@invoice), method: :post, local: true do |form| %>
          <%= hidden_field_tag :is_resend, true %>
          <div class="modal-body">
            <div class="mb-3">
              <p><strong>請求書番号:</strong> <%= @invoice.invoice_number %></p>
              <p><strong>取引先:</strong> <%= @invoice.customer.company_name %></p>
              <p class="text-muted">この請求書は既にメール送信済みです。再送信しますか？</p>
            </div>
            <div class="mb-3">
              <label for="resend_reason" class="form-label">再送信理由（任意）</label>
              <%= text_area_tag :resend_reason, '', class: 'form-control', id: "resend_reason", rows: 3, placeholder: '再送信理由を入力してください' %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            <%= form.submit '再送信', class: 'btn btn-warning' %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>