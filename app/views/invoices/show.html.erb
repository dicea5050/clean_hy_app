<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>請求情報詳細</h1>
    <div>
      <%= link_to '請求書PDF', pdf_invoice_path(@invoice, format: :pdf), class: 'btn btn-success', target: '_blank' %>
      <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#receiptModal">
        領収書発行
      </button>
      <% if @invoice.approval_status == Invoice::APPROVAL_STATUSES[:approved] %>
        <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-primary edit-approved-invoice', 
                    data: { invoice_id: @invoice.id, approval_status: @invoice.approval_status } %>
      <% else %>
        <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-primary' %>
      <% end %>
      <%= link_to '一覧に戻る', invoices_path, class: 'btn btn-secondary' %>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-light">
      <h2 class="card-title">
        <%= @invoice.invoice_number %>
        <span class="<%= @invoice.approval_status_badge_class %> ms-2"><%= @invoice.approval_status %></span>
        <span class="<%= @invoice.payment_status_badge_class %> ms-2"><%= @invoice.payment_status %></span>
      </h2>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <h5>取引先:</h5>
          <p><%= @invoice.customer.company_name %></p>
        </div>
        <div class="col-md-4">
          <h5>請求日:</h5>
          <p><%= l @invoice.invoice_date %></p>
        </div>
        <div class="col-md-4">
          <h5>支払期限:</h5>
          <p><%= l @invoice.due_date if @invoice.due_date %></p>
        </div>
      </div>

      <% if @invoice.notes.present? %>
        <div class="row mt-3">
          <div class="col-12">
            <h5>備考:</h5>
            <p><%= simple_format @invoice.notes %></p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%= render 'rejection_reason' %>

  <h3>対象受注</h3>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>受注番号</th>
        <th>受注日</th>
        <th>確定納品日</th>
        <th>合計金額（税抜）</th>
        <th>合計金額（税込）</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @invoice.orders.each do |order| %>
        <tr>
          <td><%= link_to order.order_number, order_path(order) %></td>
          <td><%= l order.order_date %></td>
          <td><%= l order.actual_delivery_date if order.actual_delivery_date %></td>
          <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal_without_tax }) %></td>
          <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal }) %></td>
          <td>
            <%= link_to '詳細', order_path(order), class: 'btn btn-sm btn-info' %>
          </td>
        </tr>
      <% end %>
      <tr class="table-info">
        <td colspan="3"><strong>合計</strong></td>
        <td><strong><%= number_to_currency(@invoice.total_amount_without_tax) %></strong></td>
        <td><strong><%= number_to_currency(@invoice.total_amount) %></strong></td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <div class="mt-4 mb-3">
    <% 
      # 請求金額（税込）
      request_amount = @invoice.total_amount
      # 繰越金額
      carryover_amount = @carryover_amount || 0
      # 請求合計金額
      total_request_amount = request_amount + carryover_amount
    %>
    <div class="row">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">請求金額</h5>
            <p class="card-text h4 text-primary">
              <%= number_to_currency(request_amount) %>
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">繰越金額</h5>
            <p class="card-text h4 text-warning">
              <%= number_to_currency(carryover_amount) %>
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">請求合計金額</h5>
            <p class="card-text h4 text-success">
              <%= number_to_currency(total_request_amount) %>
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">入金済み金額</h5>
            <p class="card-text h4 text-info">
              <%= number_to_currency(@invoice.total_paid_amount) %>
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">未入金金額</h5>
            <p class="card-text h4 text-danger">
              <%= number_to_currency(@invoice.unpaid_amount) %>
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-3">
      <%= link_to '入金管理', payment_management_index_path, class: 'btn btn-primary' %>
    </div>
  </div>

  <!-- 入金履歴セクション -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h3 class="card-title mb-0">入金履歴</h3>
    </div>
    <div class="card-body">
      <% if @payment_records.any? %>
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>入金日</th>
                <th>入金ID</th>
                <th>入金種別</th>
                <th class="text-end">入金額</th>
                <th class="text-end">充当額</th>
                <th>備考</th>
              </tr>
            </thead>
            <tbody>
              <% @payment_records.each do |payment_record| %>
                <tr>
                  <td><%= l payment_record.payment_date %></td>
                  <td><%= payment_record.id %></td>
                  <td><%= payment_record.category %></td>
                  <td class="text-end"><%= number_to_currency(payment_record.amount) %></td>
                  <td class="text-end"><%= number_to_currency(payment_record.paid_amount) %></td>
                  <td><%= payment_record.notes.presence || '-' %></td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr class="table-info">
                <td colspan="3"><strong>合計</strong></td>
                <td class="text-end"><strong><%= number_to_currency(@payment_records.sum(:amount)) %></strong></td>
                <td class="text-end"><strong><%= number_to_currency(@payment_records.sum(:paid_amount)) %></strong></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      <% else %>
        <p class="text-muted text-center py-4">入金履歴はありません</p>
      <% end %>
    </div>
  </div>

  <div class="text-center mt-4">
    <%= link_to '請求書PDF', pdf_invoice_path(@invoice, format: :pdf), class: 'btn btn-success me-2', target: '_blank' %>
    <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#receiptModal">
      領収書発行
    </button>
    <button class="btn btn-secondary" onclick="window.print();">印刷する</button>
  </div>
</div>

<!-- 領収書発行モーダル -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="receiptModalLabel">領収書発行</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with url: receipt_invoice_path(@invoice, format: :pdf), method: :get, local: true, target: '_blank' do |form| %>
          <div class="mb-3">
            <label for="issue_date" class="form-label">発行日</label>
            <%= form.date_field :issue_date, value: Date.current, class: 'form-control', required: true %>
          </div>
          <div class="mb-3">
            <p><strong>顧客名:</strong> <%= @invoice.customer.company_name %></p>
            <% if @invoice.customer.customer_code.present? %>
              <p><strong>顧客コード:</strong> <%= @invoice.customer.customer_code %></p>
            <% end %>
            <p><strong>領収金額:</strong> <%= number_to_currency(@invoice.total_amount) %></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            <%= form.submit '領収書PDF発行', class: 'btn btn-warning' %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>