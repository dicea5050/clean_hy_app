<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>請求情報詳細</h1>
    <div>
      <%= render 'shared/invoice_pdf_button', invoice: @invoice %>
      <%= render 'shared/invoice_receipt_button', invoice: @invoice, modal_id: 'receiptModal' %>
      <% if @invoice.approval_status == Invoice::APPROVAL_STATUSES[:approved] %>
        <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-sm btn-primary edit-approved-invoice',
                    data: { invoice_id: @invoice.id, approval_status: @invoice.approval_status } %>
      <% else %>
        <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-sm btn-primary' %>
      <% end %>
      <%= render 'shared/show_action_buttons',
                  edit_path: nil,
                  delete_path: nil,
                  back_path: invoices_path %>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-light">
      <h2 class="card-title">
        <%= @invoice.invoice_number %>
        <%= render 'shared/approval_status_badge', invoice: @invoice, margin_class: 'ms-2' %>
        <%= render 'shared/payment_status_badge', object: @invoice, margin_class: 'ms-2' %>
      </h2>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <div class="d-flex align-items-center">
            <strong class="me-2">取引先:</strong>
            <span><%= @invoice.customer.company_name %></span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="d-flex align-items-center">
            <strong class="me-2">請求日:</strong>
            <span><%= l @invoice.invoice_date %></span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="d-flex align-items-center">
            <strong class="me-2">支払期限:</strong>
            <span><%= l @invoice.due_date if @invoice.due_date %></span>
          </div>
        </div>
      </div>

      <%
        # 請求金額（税込）
        request_amount = @invoice.total_amount
        # 繰越金額
        carryover_amount = @carryover_amount || 0
        # 請求合計金額
        total_request_amount = request_amount + carryover_amount
      %>
      <div class="row mt-3">
        <div class="col-md-3">
          <div class="card">
            <div class="card-body d-flex justify-content-between align-items-center py-2">
              <span class="mb-0">請求金額</span>
              <span class="h4 text-primary mb-0">
                <%= number_to_currency(request_amount) %>
              </span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body d-flex justify-content-between align-items-center py-2">
              <span class="mb-0">繰越金額</span>
              <span class="h4 text-warning mb-0">
                <%= number_to_currency(carryover_amount) %>
              </span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body d-flex justify-content-between align-items-center py-2">
              <span class="mb-0">請求合計金額</span>
              <span class="h4 text-success mb-0">
                <%= number_to_currency(total_request_amount) %>
              </span>
            </div>
          </div>
        </div>
      </div>

      <% if @invoice.notes.present? %>
        <div class="row mt-3">
          <div class="col-12">
            <h5>備考:</h5>
            <p><%= simple_format @invoice.notes %></p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%= render 'rejection_reason' %>

  <h3>対象受注</h3>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>受注番号</th>
        <th>受注日</th>
        <th>確定納品日</th>
        <th>合計金額（税抜）</th>
        <th>合計金額（税込）</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @invoice.orders.each do |order| %>
        <tr>
          <td><%= link_to order.order_number, order_path(order) %></td>
          <td><%= l order.order_date %></td>
          <td><%= l order.actual_delivery_date if order.actual_delivery_date %></td>
          <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal_without_tax }) %></td>
          <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal }) %></td>
          <td>
            <%= link_to '詳細', order_path(order), class: 'btn btn-sm btn-info' %>
          </td>
        </tr>
      <% end %>
      <tr class="table-info">
        <td colspan="3"><strong>合計</strong></td>
        <td><strong><%= number_to_currency(@invoice.total_amount_without_tax) %></strong></td>
        <td><strong><%= number_to_currency(@invoice.total_amount) %></strong></td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <!-- 入金履歴セクション -->
  <div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h3 class="card-title mb-0">入金履歴</h3>
      <%= link_to '入金登録', payment_management_index_path, class: 'btn btn-sm btn-primary' %>
    </div>
    <div class="card-body">
      <% if @payment_records.any? %>
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>入金日</th>
                <th>入金ID</th>
                <th>入金種別</th>
                <th class="text-end">入金額</th>
                <th class="text-end">充当額</th>
                <th>備考</th>
              </tr>
            </thead>
            <tbody>
              <% @payment_records.each do |payment_record| %>
                <tr>
                  <td><%= l payment_record.payment_date %></td>
                  <td><%= payment_record.id %></td>
                  <td><%= payment_record.category %></td>
                  <td class="text-end"><%= number_to_currency(payment_record.amount) %></td>
                  <td class="text-end"><%= number_to_currency(payment_record.paid_amount) %></td>
                  <td><%= payment_record.notes.presence || '-' %></td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr class="table-info">
                <td colspan="3"><strong>合計</strong></td>
                <td class="text-end"><strong><%= number_to_currency(@payment_records.sum(:amount)) %></strong></td>
                <td class="text-end"><strong><%= number_to_currency(@payment_records.sum(:paid_amount)) %></strong></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      <% else %>
        <p class="text-muted text-center py-4">入金履歴はありません</p>
      <% end %>
    </div>
  </div>

  <div class="text-center mt-4 mb-3">
    <%= render 'shared/invoice_pdf_button', invoice: @invoice %>
    <%= render 'shared/invoice_receipt_button', invoice: @invoice, modal_id: 'receiptModal' %>
    <% if @invoice.approval_status == Invoice::APPROVAL_STATUSES[:approved] %>
      <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-sm btn-primary edit-approved-invoice',
                  data: { invoice_id: @invoice.id, approval_status: @invoice.approval_status } %>
    <% else %>
      <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-sm btn-primary' %>
    <% end %>
    <%= render 'shared/show_action_buttons',
                edit_path: nil,
                delete_path: nil,
                back_path: invoices_path %>
  </div>
</div>

<!-- 領収書発行モーダル -->
<%= render 'shared/invoice_receipt_modal', invoice: @invoice, modal_id: 'receiptModal' %>