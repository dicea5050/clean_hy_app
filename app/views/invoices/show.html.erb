<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>請求書詳細</h1>
    <div>
      <%= link_to '請求書PDF', pdf_invoice_path(@invoice, format: :pdf), class: 'btn btn-success', target: '_blank' %>
      <%= link_to '編集', edit_invoice_path(@invoice), class: 'btn btn-primary' %>
      <%= link_to '一覧に戻る', invoices_path, class: 'btn btn-secondary' %>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h2 class="card-title">
        <%= @invoice.invoice_number %>
        <span class="<%= @invoice.approval_status_badge_class %> ms-2"><%= @invoice.approval_status %></span>
        <span class="<%= @invoice.payment_status_badge_class %> ms-2"><%= @invoice.payment_status %></span>
      </h2>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <h5>取引先:</h5>
          <p><%= @invoice.customer.company_name %></p>
        </div>
        <div class="col-md-4">
          <h5>請求日:</h5>
          <p><%= l @invoice.invoice_date %></p>
        </div>
        <div class="col-md-4">
          <h5>支払期限:</h5>
          <p><%= l @invoice.due_date if @invoice.due_date %></p>
        </div>
      </div>

      <% if @invoice.notes.present? %>
        <div class="row mt-3">
          <div class="col-12">
            <h5>備考:</h5>
            <p><%= simple_format @invoice.notes %></p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <h3>対象受注</h3>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>受注番号</th>
        <th>受注日</th>
        <th>確定納品日</th>
        <th>合計金額（税抜）</th>
        <th>合計金額（税込）</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @invoice.orders.each do |order| %>
        <tr>
          <td><%= link_to order.order_number, order_path(order) %></td>
          <td><%= l order.order_date %></td>
          <td><%= l order.actual_delivery_date if order.actual_delivery_date %></td>
          <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal_without_tax }) %></td>
          <td><%= number_to_currency(order.order_items.sum { |item| item.subtotal }) %></td>
          <td>
            <%= link_to '詳細', order_path(order), class: 'btn btn-sm btn-info' %>
          </td>
        </tr>
      <% end %>
      <tr class="table-info">
        <td colspan="3"><strong>合計</strong></td>
        <td><strong><%= number_to_currency(@invoice.total_amount_without_tax) %></strong></td>
        <td><strong><%= number_to_currency(@invoice.total_amount) %></strong></td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <!-- 入金管理セクション -->
  <div class="payment-management mt-4 mb-3">
    <h3>入金管理</h3>

    <div class="payment-summary mb-3">
      <div class="row">
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">請求金額</h5>
              <p class="card-text h4 text-primary">
                <%= number_to_currency(@invoice.total_amount) %>
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">入金済み金額</h5>
              <p class="card-text h4 text-success">
                <%= number_to_currency(@invoice.total_paid_amount) %>
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">未入金金額</h5>
              <p class="card-text h4 text-danger">
                <%= number_to_currency(@invoice.unpaid_amount) %>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th style="width: 20%;">入金日</th>
          <th style="width: 15%;">科目</th>
          <th style="width: 20%;">入金額</th>
          <th style="width: 45%;">メモ</th>
        </tr>
      </thead>
      <tbody>
        <% @invoice.payment_records.order(:payment_date).each do |payment| %>
          <tr>
            <td><%= l payment.payment_date %></td>
            <td><%= payment.payment_type %></td>
            <td class="text-end"><%= number_to_currency(payment.amount) %></td>
            <td><%= payment.memo %></td>
          </tr>
        <% end %>
        <% if @invoice.payment_records.empty? %>
          <tr>
            <td colspan="4" class="text-center">入金記録がありません</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="text-center mt-4">
    <%= link_to '請求書PDF', pdf_invoice_path(@invoice, format: :pdf), class: 'btn btn-success me-2', target: '_blank' %>
    <button class="btn btn-secondary" onclick="window.print();">印刷する</button>
  </div>
</div>