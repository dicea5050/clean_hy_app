<div class="container">
  <h1>請求書編集</h1>

  <%= form_with(model: @invoice, local: true) do |form| %>
    <% if @invoice.errors.any? %>
      <div class="alert alert-danger">
        <h2><%= pluralize(@invoice.errors.count, "エラー") %> が発生しました:</h2>
        <ul>
          <% @invoice.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= hidden_field_tag :order_ids, @order_ids.join(',') if @order_ids.present? %>

    <div class="row mb-3">
      <div class="col-md-6">
        <div class="form-group">
          <label>請求書番号</label>
          <div class="d-flex align-items-center">
            <span class="form-control-plaintext"><%= @invoice.invoice_number %></span>
            <span class="<%= @invoice.approval_status_badge_class %> ms-2"><%= @invoice.approval_status %></span>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-4">
        <div class="form-group">
          <%= form.label :customer_id, '取引先' %>
          <%= form.collection_select :customer_id, @customers, :id, :company_name,
                                    { prompt: '取引先を選択してください' },
                                    { class: 'form-control', disabled: true } %>
          <small class="form-text text-muted">取引先は変更できません</small>
        </div>
      </div>

      <div class="col-md-4">
        <div class="form-group">
          <%= form.label :invoice_date, '請求日' %>
          <%= form.date_field :invoice_date, class: 'form-control' %>
        </div>
      </div>

      <div class="col-md-4">
        <div class="form-group">
          <%= form.label :due_date, '支払期限' %>
          <%= form.date_field :due_date, class: 'form-control' %>
        </div>
      </div>
    </div>

    <div class="form-group mb-3">
      <%= form.label :notes, '備考' %>
      <%= form.text_area :notes, class: 'form-control' %>
    </div>

    <% if @orders.present? %>
      <h3>選択された受注情報</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>確定納品日</th>
            <th>受注番号</th>
            <th>商品</th>
            <th>数量</th>
            <th>小計（税抜）</th>
            <th>小計（税込）</th>
          </tr>
        </thead>
        <tbody>
          <% current_order_id = nil %>
          <% @orders.each do |order| %>
            <% order.order_items.each_with_index do |item, index| %>
              <tr>
                <td>
                  <% if current_order_id != order.id %>
                    <%= l order.actual_delivery_date if order.actual_delivery_date %>
                  <% end %>
                </td>
                <td>
                  <% if current_order_id != order.id %>
                    <%= order.order_number %>
                  <% end %>
                </td>
                <td><%= item.product.name %></td>
                <td><%= item.quantity %></td>
                <td class="text-right"><%= number_to_currency(item.subtotal_without_tax) %></td>
                <td class="text-right"><%= number_to_currency(item.subtotal) %></td>
              </tr>
              <% current_order_id = order.id %>
            <% end %>
          <% end %>
          <tr class="table-info">
            <td colspan="4"><strong>合計</strong></td>
            <td><strong><%= number_to_currency(@orders.sum { |order| order.order_items.sum { |item| item.subtotal_without_tax } }) %></strong></td>
            <td class="total-invoice-amount"><strong><%= number_to_currency(@orders.sum { |order| order.order_items.sum { |item| item.subtotal } }) %></strong></td>
          </tr>
        </tbody>
      </table>
    <% else %>
      <div class="alert alert-warning">
        選択された受注情報がありません。
      </div>
    <% end %>

    <!-- 入金管理セクション -->
    <div class="payment-management mt-4 mb-3">
      <h3>入金管理</h3>

      <div class="payment-summary mb-3">
        <div class="row">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">請求金額</h5>
                <p class="card-text h4 text-primary total-invoice-amount-display">
                  <%= number_to_currency(@orders.present? ? @orders.sum { |order| order.order_items.sum { |item| item.subtotal } } : 0) %>
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">入金済み金額</h5>
                <p class="card-text h4 text-success total-paid-amount">
                  <%= number_to_currency(@invoice.total_paid_amount) %>
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">未入金金額</h5>
                <p class="card-text h4 text-danger unpaid-amount">
                  <%= number_to_currency(@invoice.unpaid_amount) %>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <table class="table table-bordered payment-records-table">
        <thead class="table-light">
          <tr>
            <th style="width: 20%;">入金日</th>
            <th style="width: 15%;">科目</th>
            <th style="width: 20%;">入金額</th>
            <th style="width: 35%;">メモ</th>
            <th style="width: 10%;">操作</th>
          </tr>
        </thead>
        <tbody id="payment-records-container">
          <%= form.fields_for :payment_records do |payment_form| %>
            <tr class="payment-record-row">
              <td>
                <%= payment_form.date_field :payment_date, class: 'form-control payment-date' %>
              </td>
              <td>
                <%= payment_form.select :payment_type,
                                       PaymentRecord::PAYMENT_TYPES.values,
                                       { include_blank: '選択してください' },
                                       { class: 'form-control payment-type' } %>
              </td>
              <td>
                <div class="input-group">
                  <span class="input-group-text">¥</span>
                  <%= payment_form.number_field :amount,
                                               class: 'form-control payment-amount',
                                               min: 0,
                                               step: 1 %>
                </div>
              </td>
              <td>
                <%= payment_form.text_field :memo, class: 'form-control payment-memo' %>
              </td>
              <td class="text-center">
                <button type="button" class="btn btn-danger remove-payment-record">
                  <i class="bi bi-trash"></i> 削除
                </button>
                <%= payment_form.hidden_field :_destroy, class: 'destroy-flag' %>
              </td>
            </tr>
          <% end %>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5">
              <button type="button" class="btn btn-primary" id="add-payment-record">
                <i class="bi bi-plus-circle"></i> 行を追加
              </button>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="form-group text-center mt-4">
      <%= form.submit '更新する', class: 'btn btn-primary' %>
      <%= link_to '詳細', @invoice, class: 'btn btn-info' %>
      <%= link_to '戻る', invoices_path, class: 'btn btn-secondary' %>
    </div>
  <% end %>
</div>