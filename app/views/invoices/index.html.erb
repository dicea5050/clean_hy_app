<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1>請求情報一覧</h1>
    </div>
  </div>

  <!-- 検索フォーム -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <button class="btn btn-link btn-sm text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#searchCollapse" aria-expanded="true" aria-controls="searchCollapse">
        <i class="bi bi-search"></i> 検索条件
      </button>
    </div>
    <div class="collapse show" id="searchCollapse">
      <div class="card-body">
        <%= form_with url: invoices_path, method: :get, local: true, id: 'search-form', class: 'row g-3' do %>
          <!-- 1行目：顧客コード、取引先名、請求書番号、請求書送付方法 -->
          <div class="col-md-2 me-3">
            <label class="form-label">顧客コード</label>
            <%= text_field_tag 'search[customer_code]', params.dig(:search, :customer_code), class: 'form-control' %>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">取引先名</label>
            <div class="position-relative">
              <%= text_field_tag 'search[company_name]', params.dig(:search, :company_name), 
                  id: "invoice_company_name_search",
                  class: 'form-control',
                  autocomplete: "off" %>
              <div id="invoice_company_name_suggestions" class="position-absolute w-100 bg-white border rounded shadow-lg" style="z-index: 1000; display: none;"></div>
            </div>
          </div>

          <div class="col-md-2 me-3">
            <label class="form-label">請求書番号</label>
            <%= text_field_tag 'search[invoice_number]', params.dig(:search, :invoice_number), class: 'form-control' %>
          </div>

          <div class="col-md-2">
            <label class="form-label">請求書送付方法</label>
            <%= select_tag 'search[delivery_method]',
                options_for_select([
                  ['選択してください', ''],
                  ['電子請求', 'electronic'],
                  ['郵送', 'postal']
                ], params.dig(:search, :delivery_method)),
                class: 'form-select' %>
          </div>

          <!-- 2行目：請求日、請求金額（80%）、支払期限、承認状態 -->
          <div class="col-md-4 me-3 clear-left">
            <label class="form-label">請求日</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= date_field_tag 'search[invoice_date_from]', params.dig(:search, :invoice_date_from), class: 'form-control', placeholder: 'From' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= date_field_tag 'search[invoice_date_to]', params.dig(:search, :invoice_date_to), class: 'form-control', placeholder: 'To' %>
              </div>
            </div>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">請求金額</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= number_field_tag 'search[amount_from]', params.dig(:search, :amount_from), class: 'form-control', placeholder: '最低金額' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= number_field_tag 'search[amount_to]', params.dig(:search, :amount_to), class: 'form-control', placeholder: '最高金額' %>
              </div>
            </div>
          </div>

          <div class="col-md-3 me-3">
            <label class="form-label">支払期限</label>
            <div class="row g-2">
              <div class="col-md-5">
                <%= date_field_tag 'search[due_date_from]', params.dig(:search, :due_date_from), class: 'form-control', placeholder: 'From' %>
              </div>
              <div class="col-md-2 text-center d-flex align-items-center justify-content-center p-0">〜</div>
              <div class="col-md-5">
                <%= date_field_tag 'search[due_date_to]', params.dig(:search, :due_date_to), class: 'form-control', placeholder: 'To' %>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">承認状態</label>
            <div class="row g-2">
              <% Invoice::APPROVAL_STATUSES.values.each do |status| %>
                <div class="col-auto me-2">
                  <div class="form-check">
                    <%= check_box_tag 'search[approval_statuses][]',
                        status,
                        params.dig(:search, :approval_statuses)&.include?(status),
                        id: "status_#{status}",
                        class: 'form-check-input' %>
                    <label class="form-check-label" for="<%= "status_#{status}" %>"><%= status %></label>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- 3行目：入金状況 -->
          <div class="col-md-4 clear-left">
            <label class="form-label">入金状況</label>
            <div class="row g-2">
              <% Invoice::PAYMENT_STATUSES.values.each do |status| %>
                <div class="col-auto me-2">
                  <div class="form-check">
                    <%= check_box_tag 'search[payment_statuses][]',
                        status,
                        params.dig(:search, :payment_statuses)&.include?(status),
                        id: "payment_status_#{status}",
                        class: 'form-check-input' %>
                    <label class="form-check-label" for="<%= "payment_status_#{status}" %>"><%= status %></label>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- 検索ボタン -->
          <div class="col-12 mt-4 clear-left">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i> 検索
            </button>
            <%= link_to invoices_path, class: 'btn btn-outline-secondary ms-2' do %>
              <i class="bi bi-x-circle"></i> クリア
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 一括操作ボタン -->
  <div class="mb-3">
    <button type="button" class="btn btn-primary" id="bulk-request-approval-btn" disabled>
      <i class="bi bi-check-circle"></i> 選択した請求書を承認申請
    </button>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>
          <input type="checkbox" id="select-all" class="form-check-input">
        </th>
        <th>請求書番号</th>
        <th>取引先</th>
        <th>請求日</th>
        <th>支払期限</th>
        <th>請求金額</th>
        <th>送付方法</th>
        <th>承認状態</th>
        <th>入金状況</th>
        <th>操作</th>
      </tr>
    </thead>

    <tbody>
      <% @invoices.each do |invoice| %>
        <tr>
          <td>
            <% if invoice.approval_status == Invoice::APPROVAL_STATUSES[:rejected] %>
              <input type="checkbox" name="invoice_ids[]" value="<%= invoice.id %>" class="form-check-input invoice-checkbox">
            <% else %>
              <input type="checkbox" disabled class="form-check-input" title="差し戻しステータスの請求書のみ選択可能です">
            <% end %>
          </td>
          <td><%= link_to invoice.invoice_number, invoice_path(invoice) %></td>
          <td><%= invoice.customer.company_name %></td>
          <td><%= l invoice.invoice_date %></td>
          <td><%= l invoice.due_date if invoice.due_date %></td>
          <td><%= number_to_currency(invoice.total_amount) %></td>
          <td>
            <%= render 'shared/invoice_delivery_method_badge', customer: invoice.customer %>
          </td>
          <td><%= render 'shared/approval_status_badge', invoice: invoice %></td>
          <td><%= render 'shared/payment_status_badge', object: invoice %></td>
          <td>
            <%= render 'shared/detail_button', path: invoice_path(invoice) %>
            <% if invoice.approval_status == Invoice::APPROVAL_STATUSES[:approved] %>
              <%= link_to '編集', edit_invoice_path(invoice), class: 'btn btn-sm btn-primary edit-approved-invoice', 
                          data: { invoice_id: invoice.id, approval_status: invoice.approval_status } %>
            <% else %>
              <%= link_to '編集', edit_invoice_path(invoice), class: 'btn btn-sm btn-primary' %>
            <% end %>
            <%= render 'shared/invoice_pdf_button', invoice: invoice, text: 'PDF' %>
            <%= render 'shared/invoice_receipt_button', invoice: invoice, text: '領収書' %>
            <% confirm_msg = t('confirms.destroy', default: '本当に削除しますか？') %>
            <%= button_to invoice_path(invoice),
                            method: :delete,
                            form: { data: { turbo_confirm: confirm_msg, confirm: confirm_msg },
                                    onsubmit: "return confirm('#{j confirm_msg}')",
                                    class: 'd-inline' },
                            class: 'btn btn-sm btn-danger' do %>
              <%= t('buttons.destroy', default: '削除') %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div class="d-flex justify-content-center">
    <%= paginate @invoices %>
  </div>
</div>

<!-- 領収書発行モーダル（各請求書用） -->
<% @invoices.each do |invoice| %>
  <%= render 'shared/invoice_receipt_modal', invoice: invoice %>
<% end %>


<%= javascript_include_tag "/assets/javascripts/search_form.js" %>

<script>
  $(document).ready(function() {
    // 全選択チェックボックス（差し戻しステータスの請求書のみ選択）
    $('#select-all').on('change', function() {
      $('.invoice-checkbox:not(:disabled)').prop('checked', $(this).prop('checked'));
      updateBulkButtonState();
    });

    // 個別チェックボックスの変更
    $(document).on('change', '.invoice-checkbox', function() {
      // 全選択チェックボックスの状態を更新（差し戻しステータスの請求書のみをカウント）
      var totalCheckboxes = $('.invoice-checkbox:not(:disabled)').length;
      var checkedCheckboxes = $('.invoice-checkbox:checked').length;
      $('#select-all').prop('checked', totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes);
      updateBulkButtonState();
    });

    // 一括承認申請ボタンのクリック
    $('#bulk-request-approval-btn').on('click', function() {
      var selectedIds = $('.invoice-checkbox:checked').map(function() {
        return $(this).val();
      }).get();

      if (selectedIds.length === 0) {
        alert('請求書を選択してください。');
        return;
      }

      if (!confirm('選択した請求書を承認申請しますか？')) {
        return;
      }

      // フォームを作成して送信
      var form = $('<form>', {
        'method': 'POST',
        'action': '<%= bulk_request_approval_invoices_path %>'
      });

      form.append($('<input>', {
        'type': 'hidden',
        'name': 'authenticity_token',
        'value': $('meta[name="csrf-token"]').attr('content')
      }));

      form.append($('<input>', {
        'type': 'hidden',
        'name': 'invoice_ids',
        'value': selectedIds.join(',')
      }));

      $('body').append(form);
      form.submit();
    });

    // ボタンの有効/無効を更新
    function updateBulkButtonState() {
      var hasChecked = $('.invoice-checkbox:checked').length > 0;
      $('#bulk-request-approval-btn').prop('disabled', !hasChecked);
    }

    // 初期状態を設定
    updateBulkButtonState();
    
    // 取引先名のインクリメンタルサーチを初期化
    if (window.CompanyNameSearch) {
      window.CompanyNameSearch.setup(document, {
        inputSelector: '#invoice_company_name_search',
        suggestionsSelector: '#invoice_company_name_suggestions',
        apiUrl: '/customers/company_name_search',
        autoSubmit: true
      });
    }
  });
</script>

<style>
.clear-left {
  clear: left;
}
</style>