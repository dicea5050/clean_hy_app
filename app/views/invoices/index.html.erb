<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1>請求書一覧</h1>
      <%= button_tag '選択した請求書の承認申請', 
          class: 'btn btn-success me-2',
          id: 'bulk-approve-button',
          disabled: true %>
      <%= link_to '新規請求書', new_invoice_path, class: 'btn btn-primary' %>
    </div>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>
          <input type="checkbox" id="select-all" class="form-check-input">
        </th>
        <th>請求書番号</th>
        <th>取引先</th>
        <th>請求日</th>
        <th>支払期限</th>
        <th>請求金額</th>
        <th>請求書方法</th>
        <th>承認状態</th>
        <th>操作</th>
      </tr>
    </thead>

    <tbody>
      <% @invoices.each do |invoice| %>
        <tr>
          <td>
            <input type="checkbox" 
                   class="form-check-input invoice-checkbox" 
                   value="<%= invoice.id %>"
                   <%= 'disabled' if invoice.approval_status != '未申請' %>>
          </td>
          <td><%= link_to invoice.invoice_number, invoice_path(invoice) %></td>
          <td><%= invoice.customer.company_name %></td>
          <td><%= l invoice.invoice_date %></td>
          <td><%= l invoice.due_date if invoice.due_date %></td>
          <td><%= number_to_currency(invoice.total_amount) %></td>
          <td>
            <% if invoice.customer.electronic? %>
              <span class="badge bg-info">電子請求</span>
            <% else %>
              <span class="badge bg-secondary">郵送</span>
            <% end %>
          </td>
          <td><span class="<%= invoice.approval_status_badge_class %>"><%= invoice.approval_status %></span></td>
          <td>
            <%= link_to '詳細', invoice, class: 'btn btn-sm btn-info' %>
            <%= link_to 'PDF', pdf_invoice_path(invoice, format: :pdf), class: 'btn btn-sm btn-secondary', target: '_blank' %>
            <%= link_to '編集', edit_invoice_path(invoice), class: 'btn btn-sm btn-primary' %>
            <%= form_with(url: invoice_path(invoice), method: :delete, class: 'd-inline') do |f| %>
              <%= f.submit '削除', class: 'btn btn-sm btn-danger', 
                           onclick: "return confirm('本当に削除しますか？');" %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div class="d-flex justify-content-center">
    <%= paginate @invoices %>
  </div>
</div>

<%# JavaScriptを更新 %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAll = document.getElementById('select-all');
  const invoiceCheckboxes = document.querySelectorAll('.invoice-checkbox:not([disabled])');
  const bulkApproveButton = document.getElementById('bulk-approve-button');

  // 全選択チェックボックスの制御
  selectAll.addEventListener('change', function() {
    invoiceCheckboxes.forEach(checkbox => {
      checkbox.checked = this.checked;
    });
    updateBulkApproveButton();
  });

  // 個別チェックボックスの制御
  invoiceCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateBulkApproveButton();
      updateSelectAllCheckbox();
    });
  });

  // 承認申請ボタンの有効/無効を制御
  function updateBulkApproveButton() {
    const checkedCount = document.querySelectorAll('.invoice-checkbox:checked').length;
    bulkApproveButton.disabled = checkedCount === 0;
  }

  // 全選択チェックボックスの状態を更新
  function updateSelectAllCheckbox() {
    const allChecked = Array.from(invoiceCheckboxes).every(checkbox => checkbox.checked);
    selectAll.checked = allChecked;
  }

  // 承認申請ボタンのクリックイベントを追加
  bulkApproveButton.addEventListener('click', function() {
    const checkedBoxes = document.querySelectorAll('.invoice-checkbox:checked');
    if (checkedBoxes.length === 0) return;

    const invoiceIds = Array.from(checkedBoxes).map(cb => cb.value).join(',');

    if (confirm('選択した請求書を承認申請します。よろしいですか？')) {
      // フォームを動的に作成して送信
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/invoice_approvals/bulk_create';
      
      // CSRF Token
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'authenticity_token';
      csrfInput.value = csrfToken;
      
      // 請求書IDsのinput
      const idsInput = document.createElement('input');
      idsInput.type = 'hidden';
      idsInput.name = 'invoice_ids';
      idsInput.value = invoiceIds;
      
      form.appendChild(csrfInput);
      form.appendChild(idsInput);
      document.body.appendChild(form);
      form.submit();
    }
  });
});
</script> 