<div class="container" style="max-width: 1500px;" data-controller="payment-management">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-2">入金管理</h2>
      <p class="text-muted mb-0">発行済み請求書への入金消し込みを行います</p>
    </div>
    <%= link_to '請求書一覧に戻る', invoices_path, class: 'btn btn-secondary' %>
  </div>

  <!-- 取引先選択カード -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">取引先選択</h5>
      <div class="row">
        <div class="col-md-5">
          <div class="form-group">
            <label for="customer-select" class="form-label">取引先名</label>
            <select id="customer-select" class="form-select" data-payment-management-target="customerSelect" data-action="change->payment-management#onCustomerChange">
              <option value="">選択してください</option>
              <% @customers.each do |customer| %>
                <option value="<%= customer.id %>"><%= customer.company_name %></option>
              <% end %>
            </select>
          </div>
        </div>
        <div class="col-md-5 d-flex align-items-end">
          <div class="d-flex gap-2 w-100" data-payment-management-target="invoiceButtons">
            <button type="button" class="btn btn-primary payment-btn rounded" data-action="click->payment-management#loadUnpaidInvoices" data-payment-management-target="unpaidButton" disabled>
              入金未完了請求書を表示
            </button>
            <button type="button" class="btn btn-primary payment-btn rounded" data-action="click->payment-management#loadPaidInvoices" data-payment-management-target="paidButton" disabled>
              入金済み請求書を表示
            </button>
            <button type="button" class="btn btn-primary payment-btn rounded" data-action="click->payment-management#loadPaymentHistory" data-payment-management-target="historyButton" disabled>
              入金履歴を表示
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 請求書一覧カード -->
  <div class="card shadow-sm mb-4" data-payment-management-target="invoicesCard" style="display: none;">
    <div class="card-body">
      <h5 class="card-title" data-payment-management-target="invoicesTitle">請求書一覧</h5>
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead data-payment-management-target="tableHeader">
            <tr>
              <th>請求書番号</th>
              <th>請求日</th>
              <th>請求金額（税込）</th>
              <th>入金済み額</th>
              <th>未入金額</th>
              <th>充当予定額</th>
              <th>充当後残高</th>
              <th>入金ID</th>
            </tr>
          </thead>
          <tbody data-payment-management-target="invoicesTableBody">
            <!-- JavaScript で動的に生成 -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 入金入力カード -->
  <div class="card shadow-sm mb-4" data-payment-management-target="paymentCard" style="display: none;">
    <div class="card-body">
      <h5 class="card-title">入金入力</h5>
      <%= form_with url: payment_management_index_path, method: :post, local: true, scope: :payment, data: { payment_management_target: "paymentForm" } do |form| %>
        <div class="row">
          <div class="col-md-3">
            <div class="form-group">
              <%= form.label :payment_date, "入金日", class: "form-label" %>
              <%= form.date_field :payment_date, value: Date.current, class: "form-control", required: true %>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <%= form.label :category, "入金種別", class: "form-label" %>
              <%= form.select :category, 
                  options_for_select([
                    ['入金（振込）', '入金（振込）'],
                    ['入金（現金）', '入金（現金）'],
                    ['振込手数料', '振込手数料'],
                    ['相殺', '相殺'],
                    ['返金', '返金']
                  ]), 
                  { prompt: "選択してください" }, 
                  { class: "form-select", required: true } %>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <%= form.label :amount, "入金額", class: "form-label" %>
              <%= form.number_field :amount, class: "form-control", min: 1, step: 1, required: true, data: { payment_management_target: "amountInput", action: "input->payment-management#calculateAllocation" } %>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <%= form.label :notes, "備考", class: "form-label" %>
              <%= form.text_field :notes, class: "form-control" %>
            </div>
          </div>
        </div>
        
        <div class="row mt-3">
          <div class="col-md-6">
            <button type="button" class="btn btn-success" data-action="click->payment-management#confirmPayment" data-payment-management-target="confirmButton" disabled>
              消し込み登録
            </button>
          </div>
          <div class="col-md-6 text-end">
            <div class="alert alert-info mb-0" data-payment-management-target="allocationSummary" style="display: none;">
              <!-- 充当結果サマリー -->
            </div>
          </div>
        </div>

        <!-- 隠しフィールド -->
        <%= form.hidden_field :customer_id, data: { payment_management_target: "customerIdField" } %>
      <% end %>
    </div>
  </div>

  <!-- ローディング表示 -->
  <div class="text-center" data-payment-management-target="loadingSpinner" style="display: none;">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">読み込み中...</span>
    </div>
  </div>
</div>

